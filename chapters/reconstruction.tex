%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% reconstruction.tex:
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\chapter{Event Reconstruction}
\label{reconstruction_chapter}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
In order to perform neutrino oscillation analysis one need to select neutrino events 
and carefully measure its energies. For this task data from the detectors have to be 
reconstructed and $\nu_\mu$ charge current (CC) interactions should be identified. The following
points briefly summarize the reconstruction chain 
\begin{itemize}
\item Slicing. The full 550$\mu s$ readout window contains hits which are associated with
neutrino interaction, cosmis rays activity and noise. The hits need to be separated into
different groups which ideally correspond to different physical processes.
\item Tracking. Group of hits ("slice") from a previous step processed by tracking algorithm
in order to detrmine 3-dimensional trajectories of particles.
\item Calibration. Before energy of the event could be estimated signal from every hit is needed 
to be converted into energy units.
\item Muon identification and Background rejection. $\nu_\mu$ CC interaction produce a muon and, 
thus finding a muon track in a slice indicates that the slice contains information about neutrino.
\item Energy estimation. Templates are used to map muon track length to true muon energy and visible 
hadronic energy\footnote{Total energy of all hits in the slice which do not belong muon track} to true 
hadronic energy in order to determine neutrino total energy.  
\end{itemize}
Analysis done in this thesis is based on two different neutrino samples - contained and uncontained -
which were selected and processed by different algorithms. Muon identification and energy estimation
algorithms for the contained sample are explaned in this chapter, algorithms which were used for 
uncontained sample are explained in separate chapters.

\section{Slicing}
As can be seen on the figure \ref{fig:EVD_full} data recorded for one NuMI spill contains
multple uncorrelated activities. Even though the length of NuMI spill is 10$\mu s$ in the middle
of 550$\mu s$ readout window slicer algorithm is applied to all the hits in the window to protect 
against small possible drift of NuMI spills as well as to make slices for cosmic rays for background
estimation.

The task of the slicer is to group hits, which casually related to each other, in slices. The slicer 
is based on DBSCAN algorithm \cite{DBSCAN}, one of the most common clustering algorithms, and checks 
evey pair of hits to determine how far are they from each other in space and time. The distance 
function is not exactly spice-time interval but rather modified 
\be
d = \Big(\frac{\Delta t - \frac{\Delta r}{c}}{T_{res}}\Big)^2 + \Big(\frac{\Delta z}{D_z}\Big) + 
\Big(\frac{\Delta v}{D_v}\Big),
\ee 
where $c$ is the speed of light, $\Delta t$ and $\Delta r$ are time and space difference between two 
hits respectively, $T_{res}$ is the timing resolution, $\Delta z$ is the distance between the hits
along the z direction, $\Delta v$ is the distance between hits in x or y direction. As soon as the 
function returns value which is lower than predefined treshold, two hits are put together in one slice.
The first term prefers hits which lie close to a light cone, in other words it is assumed that all
the particles move with the speed of light\footnote{Or energy of the particles is much large than their 
masses.} The second and the third terms penalize hits which are far from each other in space. These
terms help to remove noise hits as they are randomly distributed in space and time, and thefore, they 
could be far from the main activity. After all corellated activities have been found and slices are 
created the rest of the hits are put into one additional noise slice.

NOvA slicing algorithms does a good work in separating different neutrino activities in the near detector
and separating cosmic activities from neutrino one in teh far detector. However, hits which were produced
by Michele electrons\footnote{Electron produced in muon decay often called after Louis Michele who
contributed significantly to the physics of charged leptons decay.} or photons follow neutrons capture are
usually not included in the corresponding slice.
\begin{figure}[t]
\includegraphics[width=1.0\textwidth]{figures/Evd_Slicing_FD.pdf}
\centering
\caption{Trigger window in the far detector data. Hits are colored by the time they were recorded.} 
\label{fig:EVD_full}
\end{figure}

\section{Tracking}
As all the activities are separated into corresponding slices the next step in reconstruction chain is 
to find sets of hits which are attributed to the different particles produced in the neutrino interaction 
or cosmic activity. The latter activity usually produced by one particle, while the former one has 
multiple particles. 

NOvA tracking algorithm is based on Kalman filtering \cite{Kalman} and its implementation could be found 
in \cite{Nick}. In short, algorithm is run on two views (X and Y) separately and merge 2D tracks into
3D ones. To construct a 2D track two hits with separation smaller than three planes are choosen as track 
seeds at most downstream location\footnote{Downstream in a sence of incoming neutrino from Fermilab}. 
Algorithm is working upstream and added hits are fit with piecewise linear segments. To add hit or not 
is decided on the basis of how much is the $\chi^2$ is changed for the hit; if less than eight units 
then hit is added. Fitting track with linear segments naturally helps to follow particles trajectory 
with multiple scatterings. Track is considered to be reconstructed if algorithm travels more than 3 planes
and no hits are added. Algorithm is run repetitively until no more tracks could be reconstructed. Majority 
of the particles produced by neutrino interactions are travels dowstream and thus the longest track is 
reconstructed first.

After all 2D tracks are found in both views they need to be merged into 3D tracks. Tracks merging is based
on score function which uses proximity of X- and Y-view tracks start and end points in Z-direction and 
extent of overlap. For each track in X view with Z coordinates $(z_{x1}, z_{x2})$ and track in Y view with
Z coordinates $(z_{y1}, z_{y2})$
\be
\text{score} = \frac{|z_{x1}-z_{y1}| + |z_{x2}-z_{y2}|}{\min(z_{x2},z_{y2}) - \max(z_{x1},z_{y1})}.
\ee
Pair of 2D tracks with the lowest score are corresponded two one particle and they merged into one 3D track.
Merging process continues until there are no 2D tracks to merge, unmatched 2D tracks are also recorded
for possible analysis later.
